{% extends 'admin/layout_admin.html' %}

{% block javascripts %}
    {{ super() }}
{% endblock %}

{% block javascripts_head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
{% endblock %}

{% block title %}
    <title>Statistiques par départements</title>
{% endblock %}

{% block body %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-2xl font-bold text-white text-center mb-6">Statistiques des commandes par départements</h1>
    
    <div class="flex justify-center mb-6 space-x-3">
        <a href="/admin/dataviz/adresses" class="rounded-md bg-accent-blue hover:bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition-colors duration-200 {% if type_viz != 'ca' %}ring-2 ring-white{% endif %}">
            Par nombre de commandes
        </a>
        <a href="/admin/dataviz/adresses?type_viz=ca" class="rounded-md bg-green-600 hover:bg-green-700 px-4 py-2 text-sm font-semibold text-white shadow-sm transition-colors duration-200 {% if type_viz == 'ca' %}ring-2 ring-white{% endif %}">
            Par chiffre d'affaires
        </a>
    </div>
    
    <!-- Top 10 Départements Chart -->
    <div class="bg-dark-secondary rounded-lg shadow-lg mb-6 overflow-hidden">
        <div class="border-b border-gray-700 px-4 py-4">
            <h2 class="text-xl font-semibold text-white">Top 10 des départements - {% if type_viz == 'ca' %}Chiffre d'affaires{% else %}Nombre de commandes{% endif %}</h2>
        </div>
        <div class="p-4">
            <canvas id="departmentsChart" height="300"></canvas>
        </div>
    </div>
    
    <!-- Charts Row -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <!-- Orders Pie Chart -->
        <div class="bg-dark-secondary rounded-lg shadow-lg overflow-hidden">
            <div class="border-b border-gray-700 px-4 py-4">
                <h2 class="text-xl font-semibold text-white">Répartition des commandes</h2>
            </div>
            <div class="p-4">
                <canvas id="ordersPieChart" height="300"></canvas>
            </div>
        </div>
        
        <!-- Revenue Pie Chart -->
        <div class="bg-dark-secondary rounded-lg shadow-lg overflow-hidden">
            <div class="border-b border-gray-700 px-4 py-4">
                <h2 class="text-xl font-semibold text-white">Répartition du chiffre d'affaires</h2>
            </div>
            <div class="p-4">
                <canvas id="revenuePieChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Data Table -->
    <div class="bg-dark-secondary rounded-lg shadow-lg mb-6 overflow-hidden">
        <div class="border-b border-gray-700 px-4 py-4">
            <h2 class="text-xl font-semibold text-white">Tableau des données par département</h2>
        </div>
        <div class="p-4 overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-700">
                <thead class="bg-dark-accent">
                    <tr>
                        <th class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-200">Département</th>
                        <th class="px-3 py-3.5 text-left text-sm font-semibold text-gray-200">Nombre de commandes</th>
                        <th class="px-3 py-3.5 text-left text-sm font-semibold text-gray-200">Chiffre d'affaires</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-700 bg-dark-secondary">
                    {% for element in adresses %}
                    <tr class="hover:bg-dark-accent transition-colors duration-200">
                        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm text-gray-300">{{ element.dep }}</td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-300">{{ element.nombre }}</td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-300">{{ element.ca_format }} €</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Navigation Button -->
    <div class="mt-6 flex justify-center">
        <a href="/admin/dataviz/etat2" class="rounded-md bg-accent-blue hover:bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition-colors duration-200">
            Voir la carte
        </a>
    </div>
</div>

{# Hidden data for JavaScript #}
<div id="jsData" 
     data-adresses="{{ adresses|tojson }}" 
     data-is-revenue-view="{{ 'true' if type_viz == 'ca' else 'false' }}" 
     style="display:none;"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get data from HTML
    var jsDataElement = document.getElementById('jsData');
    var adressesData = JSON.parse(jsDataElement.getAttribute('data-adresses'));
    var isRevenueView = jsDataElement.getAttribute('data-is-revenue-view') === 'true';
    
    // Extract data arrays
    var departments = [];
    var orderCounts = [];
    var revenues = [];
    
    adressesData.forEach(function(item) {
        departments.push(item.dep);
        orderCounts.push(parseInt(item.nombre));
        revenues.push(parseFloat(item.ca));
    });
    
    // Get top 10 data
    var top10Data = adressesData.slice(0, 10);
    var top10Departments = [];
    var top10Values = [];
    
    top10Data.forEach(function(item) {
        top10Departments.push(item.dep);
        if (isRevenueView) {
            top10Values.push(parseFloat(item.ca));
        } else {
            top10Values.push(parseInt(item.nombre));
        }
    });
    
    // Calculate totals
    var totalOrders = 0;
    orderCounts.forEach(function(count) {
        totalOrders += count;
    });
    
    var totalRevenue = 0;
    revenues.forEach(function(revenue) {
        totalRevenue += revenue;
    });
    
    // Get top 5 data
    var top5Data = adressesData.slice(0, 5);
    var top5Departments = [];
    var top5OrderCounts = [];
    var top5Revenues = [];
    
    top5Data.forEach(function(item) {
        top5Departments.push(item.dep);
        top5OrderCounts.push(parseInt(item.nombre));
        top5Revenues.push(parseFloat(item.ca));
    });
    
    // Calculate other values
    var sumTop5Orders = 0;
    top5OrderCounts.forEach(function(count) {
        sumTop5Orders += count;
    });
    var otherOrdersCount = totalOrders - sumTop5Orders;
    
    var sumTop5Revenues = 0;
    top5Revenues.forEach(function(revenue) {
        sumTop5Revenues += revenue;
    });
    var otherRevenue = totalRevenue - sumTop5Revenues;
    
    // Chart colors
    var chartColors = [
        'rgba(59, 130, 246, 0.8)',   // accent-blue
        'rgba(239, 68, 68, 0.8)',    // red
        'rgba(16, 185, 129, 0.8)',   // green
        'rgba(245, 158, 11, 0.8)',   // yellow
        'rgba(139, 92, 246, 0.8)',   // purple
        'rgba(107, 114, 128, 0.8)'   // gray
    ];
    
    var chartBorderColors = [
        'rgb(59, 130, 246)',   // accent-blue
        'rgb(239, 68, 68)',    // red
        'rgb(16, 185, 129)',   // green
        'rgb(245, 158, 11)',   // yellow
        'rgb(139, 92, 246)',   // purple
        'rgb(107, 114, 128)'   // gray
    ];
    
    // Create bar chart
    var departmentsChartCtx = document.getElementById('departmentsChart').getContext('2d');
    var departmentsChart = new Chart(departmentsChartCtx, {
        type: 'bar',
        data: {
            labels: top10Departments,
            datasets: [{
                label: isRevenueView ? 'Chiffre d\'affaires (€)' : 'Nombre de commandes',
                data: top10Values,
                backgroundColor: isRevenueView ? 'rgba(16, 185, 129, 0.8)' : 'rgba(59, 130, 246, 0.8)',
                borderColor: isRevenueView ? 'rgb(16, 185, 129)' : 'rgb(59, 130, 246)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            legend: {
                labels: {
                    fontColor: '#E5E7EB' // text-gray-200
                }
            },
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true,
                        fontColor: '#E5E7EB' // text-gray-200
                    },
                    gridLines: {
                        color: 'rgba(75, 85, 99, 0.2)' // gray-600 with opacity
                    }
                }],
                xAxes: [{
                    ticks: {
                        fontColor: '#E5E7EB' // text-gray-200
                    },
                    gridLines: {
                        color: 'rgba(75, 85, 99, 0.2)' // gray-600 with opacity
                    }
                }]
            }
        }
    });
    
    if (isRevenueView) {
        departmentsChart.options.scales.yAxes[0].ticks.callback = function(value) {
            return value.toLocaleString('fr-FR') + ' €';
        };
        departmentsChart.update();
    }
    
    // Create orders pie chart
    var orderLabels = top5Departments.slice();
    orderLabels.push('Autres');
    
    var orderData = top5OrderCounts.slice();
    orderData.push(otherOrdersCount);
    
    var ordersPieChartCtx = document.getElementById('ordersPieChart').getContext('2d');
    var ordersPieChart = new Chart(ordersPieChartCtx, {
        type: 'pie',
        data: {
            labels: orderLabels,
            datasets: [{
                data: orderData,
                backgroundColor: chartColors,
                borderColor: chartBorderColors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            legend: {
                position: 'right',
                labels: {
                    fontColor: '#E5E7EB' // text-gray-200
                }
            },
            tooltips: {
                callbacks: {
                    label: function(tooltipItem, data) {
                        var label = data.labels[tooltipItem.index] || '';
                        var value = data.datasets[0].data[tooltipItem.index] || 0;
                        var percentage = Math.round((value / totalOrders) * 100);
                        return label + ': ' + value + ' (' + percentage + '%)';
                    }
                }
            }
        }
    });
    
    // Create revenue pie chart
    var revenueLabels = top5Departments.slice();
    revenueLabels.push('Autres');
    
    var revenueData = top5Revenues.slice();
    revenueData.push(otherRevenue);
    
    var revenuePieChartCtx = document.getElementById('revenuePieChart').getContext('2d');
    var revenuePieChart = new Chart(revenuePieChartCtx, {
        type: 'pie',
        data: {
            labels: revenueLabels,
            datasets: [{
                data: revenueData,
                backgroundColor: chartColors,
                borderColor: chartBorderColors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            legend: {
                position: 'right',
                labels: {
                    fontColor: '#E5E7EB' // text-gray-200
                }
            },
            tooltips: {
                callbacks: {
                    label: function(tooltipItem, data) {
                        var label = data.labels[tooltipItem.index] || '';
                        var value = data.datasets[0].data[tooltipItem.index] || 0;
                        var percentage = Math.round((value / totalRevenue) * 100);
                        return label + ': ' + value.toLocaleString('fr-FR') + ' € (' + percentage + '%)';
                    }
                }
            }
        }
    });
});
</script>
{% endblock %} 