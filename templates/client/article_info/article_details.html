{% extends "client/layout_client.html" %}
{% block stylesheets %}
    {{ super() }}
     <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/star_rating.css') }}" >
{% endblock %}


{% block body %}
<div class="w-full">
    <!-- Article Details Card -->
    <div class="bg-dark-secondary rounded-lg shadow-lg p-6 mb-8">
        <div class="flex flex-col md:flex-row items-center md:items-start">
            <div class="w-full md:w-1/3 flex justify-center mb-6 md:mb-0">
                {% if article.image is not none %}
                    <img class="w-48 h-48 object-contain"  
                         src="{{ url_for('static', filename = 'images/')}}{{ article.image }}"  
                         alt="image de {{ article.nom }}">
                {% else %}
                    <img class="w-48 h-48 object-contain"   
                         src="{{ url_for('static', filename='images/no_photo.jpeg')}}"  
                         alt="image de {{ article.nom }}">
                {% endif %}
            </div>
            <div class="w-full md:w-2/3">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-white">{{ article.nom }}</h2>
                    <span class="text-accent-blue text-2xl font-bold">{{ article.prix }}€</span>
                </div>
                <div class="bg-dark-accent p-4 rounded-lg mb-4">
                    <h6 class="text-gray-300">Description : {{ article.description }}</h6>
                </div>
                {% if commandes_articles.nb_commandes_article is defined and commandes_articles.nb_commandes_article > 0 %}
                    <div class="bg-accent-blue bg-opacity-20 text-accent-blue p-3 rounded-lg text-center">
                        Vous avez commandé <strong>{{ commandes_articles.nb_commandes_article }}</strong> fois ce produit
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Notes Section -->
    <div class="bg-dark-secondary rounded-lg shadow-lg p-6 mb-8">
        <h3 class="text-xl font-bold text-white mb-4">Évaluation</h3>
        
        <div class="mb-6">
            {% if article.moyenne_notes is not defined or article.nb_notes is not defined or article.moyenne_notes == None %}
                <span class="text-gray-300">Pas de note</span>
            {% else %}
                <div class="flex items-center">
                    <span class="text-accent-blue font-bold text-lg mr-2">{{ article.moyenne_notes }}</span>
                    <div class="text-yellow-400 text-xl">
                        {% for i in range(article.moyenne_notes|int) %}★{% endfor %}
                        {% for i in range(5 - article.moyenne_notes|int) %}☆{% endfor %}
                    </div>
                    <span class="ml-2 text-gray-300">({{ article.nb_notes }} note(s))</span>
                </div>
            {% endif %}
        </div>

        {% if commandes_articles.nb_commandes_article is defined and commandes_articles.nb_commandes_article > 0 %}
            <div class="bg-dark-accent rounded-lg p-4">
                {% if note is defined and note is number %}
                    <form action="/client/note/edit" method="post" class="flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-4">
                        <input type="hidden" name="id_article" value="{{ article.id_article }}">
                        <label for="input_note" class="text-gray-300">Modifier votre note :</label>
                        <input type="number" name="note" id="input_note" step="0.1" min="0" max="5" 
                               class="bg-gray-700 rounded-md px-2 py-1 text-sm text-gray-300 focus:outline-none focus:ring-2 focus:ring-accent-blue w-20" 
                               value="{{ note }}">
                        <button class="bg-accent-blue hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm transition-colors duration-200">
                            Modifier votre note
                        </button>
                    </form>
                    
                    <form action="/client/note/delete" method="post" class="mt-3">
                        <input type="hidden" name="id_article" value="{{ article.id_article }}">
                        <button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md text-sm transition-colors duration-200">
                            Supprimer votre note
                        </button>
                    </form>
                {% else %}
                    <form action="/client/note/add" method="post" class="flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-4">
                        <input type="hidden" name="id_article" value="{{ article.id_article }}">
                        <label for="input_note" class="text-gray-300">Mettre une note :</label>
                        <input type="number" name="note" id="input_note" step="0.1" min="0" max="5" 
                               class="bg-gray-700 rounded-md px-2 py-1 text-sm text-gray-300 focus:outline-none focus:ring-2 focus:ring-accent-blue w-20" 
                               value="">
                        <button class="bg-accent-blue hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm transition-colors duration-200">
                            Mettre une note
                        </button>
                    </form>
                {% endif %}
            </div>
        {% else %}
            <p class="text-gray-400 text-sm italic">Seuls les clients qui ont acheté cet article peuvent le noter</p>
        {% endif %}
    </div>

    <!-- Commentaires Section -->
    <div class="bg-dark-secondary rounded-lg shadow-lg p-6 mb-8">
        <h3 class="text-xl font-bold text-white mb-4">Commentaires</h3>
        
        <div class="bg-dark-accent bg-opacity-50 p-4 rounded-lg mb-6">
            {% if nb_commentaires.nb_commentaires_total is not defined or nb_commentaires.nb_commentaires_utilisateur is not defined %}
                <span class="text-gray-300">Information sur les commentaires non disponible</span>
            {% else %}
                <div class="text-gray-300">
                    <div class="mb-1">Vos commentaires : <span class="text-accent-blue font-medium">{{ nb_commentaires.nb_commentaires_utilisateur }}</span> sur 3 maximum pour un article acheté</div>
                    <div class="mb-1">Commentaires totaux : <span class="text-accent-blue font-medium">{{ nb_commentaires.nb_commentaires_total }}</span></div>
                    {% if nb_commentaires.nb_commentaires_utilisateur_valide is defined and nb_commentaires.nb_commentaires_total_valide is defined %}
                        <div>Commentaires validés : <span class="text-accent-blue font-medium">{{ nb_commentaires.nb_commentaires_utilisateur_valide }}</span> / <span class="text-accent-blue font-medium">{{ nb_commentaires.nb_commentaires_total_valide }}</span></div>
                    {% endif %}
                </div>
            {% endif %}
        </div>

        {% if commandes_articles.nb_commandes_article is defined and commandes_articles.nb_commandes_article > 0 and 
              ((nb_commentaires.nb_commentaires_utilisateur is defined and nb_commentaires.nb_commentaires_utilisateur < 3) or nb_commentaires.nb_commentaires_utilisateur is not defined) %}
            <form action="/client/commentaire/add" method="post" class="mb-6">
                <div class="mb-4">
                    <label for="input_commentaire" class="block text-sm text-gray-300 mb-2">Ajouter un commentaire :</label>
                    <textarea name="commentaire" 
                              class="w-full bg-gray-700 rounded-md px-3 py-2 text-gray-300 focus:outline-none focus:ring-2 focus:ring-accent-blue" 
                              id="input_commentaire" 
                              rows="4" 
                              placeholder="Votre commentaire"></textarea>
                </div>
                <input type="hidden" name="action" value="add_commentaire">
                <input type="hidden" name="id_article" value="{{ article.id_article }}">
                <div class="text-right">
                    <button class="bg-accent-blue hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm transition-colors duration-200">
                        Ajouter un commentaire
                    </button>
                </div>
            </form>
        {% else %}
            <p class="text-gray-400 text-sm italic mb-6">Seuls les clients qui ont acheté cet article peuvent le commenter ou nombre maximum de commentaires atteint</p>
        {% endif %}

        <!-- Liste des commentaires -->
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-dark-accent">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider"></th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Utilisateur</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Commentaire</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Date de publication</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-700">
                    {% if commentaires %}
                        {% for commentaire in commentaires %}
                            
                            <tr class="hover:bg-dark-accent/50 transition-colors duration-200">
                                <td class="px-2 py-2 whitespace-nowrap">
                                    {% if commentaire.valide == 1 %}
                                    <svg width="15" height="15" viewBox="0 0 40 40">
                                        <circle cx="20" cy="20" r="20" fill="#4CAF50"/>
                                        <path d="M12 20L17 25L28 14" stroke="white" stroke-width="3" fill="none"/>
                                    </svg>
                                    {% endif %}
                                </td>

                                <td class="px-6 py-4 whitespace-nowrap text-gray-300">
                                    {{ commentaire.nom }} <span class="text-xs text-gray-400">({{ commentaire.utilisateur_id }})</span>
                                </td>
                                <td class="px-6 py-4 text-gray-300">
                                    {% if commentaire.utilisateur_id == 1 %}
                                        <span class="text-red-500 font-medium">(Réponse de l'administrateur) :</span>
                                    {% endif %}
                                    {{ commentaire.commentaire }}
                                    {% if commentaire.valider == 1 %}
                                        <span class="ml-2 inline-block px-2 py-1 bg-green-800 text-green-300 rounded-full text-xs">Validé</span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-gray-300">
                                    {{ commentaire.date_publication.strftime('%d/%m/%Y %H:%M') }} 
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    {% if commentaire.utilisateur_id == session['id_user'] %}
                                        <form action="/client/commentaire/delete" method="post" class="inline">
                                            <input type="hidden" name="id_article" value="{{ commentaire.id_article }}">
                                            <input type="hidden" name="utilisateur_id" value="{{ commentaire.utilisateur_id }}">
                                            <input type="hidden" name="date_publication" value="{{ commentaire.date_publication }}">
                                            <button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md text-sm transition-colors duration-200">
                                                Supprimer
                                            </button>
                                        </form>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr class="bg-dark-accent/30">
                            <td colspan="3" class="px-6 py-4 text-gray-400 text-center">Pas de commentaire</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="text-center mb-10">
        <a href="/client/article/show" class="bg-accent-blue hover:bg-blue-600 text-white px-6 py-2 rounded-md font-medium transition-colors duration-200 inline-block">
            Retour vers la page d'accueil
        </a>
    </div>
</div>
{% endblock %}