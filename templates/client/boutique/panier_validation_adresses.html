{% extends "client/layout_client.html" %}
{% block title %}
    Panier - Validation des adresses
{% endblock %}

{% block body %}
<div class="container mx-auto px-4 py-8">
    <div class="bg-dark-secondary rounded-lg shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-bold text-white mb-6">Validation de votre commande</h2>
        
        {% set nb_articles = articles_panier|length %}
        
        {% include "client/boutique/_panier.html" %}
        
        {% if nb_articles >= 1 and adresses|length >= 1 %}
            <div class="mt-10">
                <h3 class="text-xl font-semibold text-white mb-6">Sélection des adresses</h3>
                
                <div class="bg-dark-accent/30 rounded-lg p-6">
                    <form id="formValideCommande" action="/client/commande/add" method="post">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- Adresse de livraison -->
                            <div class="bg-dark-accent/50 rounded-lg p-5 shadow">
                                <h4 class="text-lg font-medium text-white mb-4 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-accent-blue" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                                    </svg>
                                    Adresse de livraison
                                </h4>
                                
                                <div class="mb-4">
                                    <label for="id_adresse_livraison" class="block text-sm font-medium text-gray-300 mb-2">Choisir une adresse :</label>
                                    <select id="id_adresse_livraison" name="adresse_livraison_id" class="block w-full rounded-md bg-gray-800 border-gray-700 text-white shadow-sm focus:ring-accent-blue focus:border-accent-blue">
                                        {% for adresse in adresses %}
                                            {% if adresse.est_valide %}
                                                {% set selected = false %}
                                                {% if request.values.get('adresse_livraison_id') == adresse.id_adresse|string %}
                                                    {% set selected = true %}
                                                {% elif not request.values.get('adresse_livraison_id') and id_adresse_fav != 0 and id_adresse_fav == adresse.id_adresse %}
                                                    {% set selected = true %}
                                                {% endif %}
                                                
                                                <option value="{{ adresse.id_adresse }}" {% if selected %}selected{% endif %}>
                                                    {{ adresse.nom }} 
                                                    {% if id_adresse_fav != 0 and id_adresse_fav == adresse.id_adresse %}(favori){% endif %} 
                                                    - {{ adresse.rue }} {{ adresse.code_postal }} {{ adresse.ville }}
                                                </option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Adresse de facturation -->
                            <div class="bg-dark-accent/50 rounded-lg p-5 shadow">
                                <h4 class="text-lg font-medium text-white mb-4 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-accent-blue" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                                    </svg>
                                    Adresse de facturation
                                </h4>
                                
                                <div class="mb-4">
                                    {% set adresse_livraison_id = request.values.get('adresse_livraison_id', id_adresse_fav|string if id_adresse_fav != 0 else '0') %}
                                    {% set adresse_facturation_id = request.values.get('adresse_facturation_id', id_adresse_fav|string if id_adresse_fav != 0 else '0') %}
                                    {% set adresses_identiques = adresse_livraison_id == adresse_facturation_id and adresse_livraison_id != '0' %}
                                    {% set message_class = "mb-3 p-2 rounded-md bg-green-500/20 text-green-300 text-sm" %}
                                    
                                    <!-- Message indiquant que les adresses sont identiques -->
                                    <div id="msgIdentique" class="{{ message_class }} {% if not adresses_identiques %}hidden{% endif %}">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                        </svg>
                                        L'adresse de facturation est identique à l'adresse de livraison
                                    </div>
                                    <input type="hidden" id="adresse_identique" name="adresse_identique" value="{% if adresses_identiques %}adresse_identique{% endif %}">
                                    
                                    <!-- Sélection d'adresse de facturation (toujours visible) -->
                                    <div>
                                        <label for="id_adresse_facturation" class="block text-sm font-medium text-gray-300 mb-2">Choisir une adresse :</label>
                                        <select id="id_adresse_facturation" name="adresse_facturation_id" class="block w-full rounded-md bg-gray-800 border-gray-700 text-white shadow-sm focus:ring-accent-blue focus:border-accent-blue">
                                            {% for adresse in adresses %}
                                                {% if adresse.est_valide %}
                                                    {% set selected = false %}
                                                    {% if request.values.get('adresse_facturation_id') == adresse.id_adresse|string %}
                                                        {% set selected = true %}
                                                    {% elif not request.values.get('adresse_facturation_id') and id_adresse_fav != 0 and id_adresse_fav == adresse.id_adresse %}
                                                        {% set selected = true %}
                                                    {% endif %}
                                                    
                                                    <option value="{{ adresse.id_adresse }}" {% if selected %}selected{% endif %}>
                                                        {{ adresse.nom }} 
                                                        {% if id_adresse_fav != 0 and id_adresse_fav == adresse.id_adresse %}(favori){% endif %} 
                                                        - {{ adresse.rue }} {{ adresse.code_postal }} {{ adresse.ville }}
                                                    </option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 flex justify-center">
                            <!-- Bouton pour finaliser la commande -->
                            <button type="submit" name="finaliser" value="1" class="rounded-md bg-accent-blue hover:bg-blue-600 px-6 py-3 text-base font-semibold text-white shadow-sm transition-colors duration-200 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
                                </svg>
                                Finaliser ma commande
                            </button>
                        </div>
                        
                        <!-- Champ caché pour indiquer l'étape -->
                        <input type="hidden" name="validation_etape" value="adresse">
                    </form>
                </div>
            </div>
        {% else %}
            <div class="bg-dark-accent rounded-lg p-6 mt-10 text-center">
                <p class="text-gray-300 mb-4">
                    {% if nb_articles < 1 %}
                        Vous n'avez aucun article dans votre panier.
                    {% else %}
                        Vous devez créer au moins une adresse avant de pouvoir valider votre commande.
                    {% endif %}
                </p>
                
                <div class="flex justify-center space-x-4">
                    {% if nb_articles < 1 %}
                        <a href="/client/article/show" class="rounded-md bg-accent-blue hover:bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition-colors duration-200">
                            Parcourir les articles
                        </a>
                    {% else %}
                        <a href="/client/coordonnee/show" class="rounded-md bg-accent-blue hover:bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition-colors duration-200">
                            Gérer mes adresses
                        </a>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const adresseLivraisonSelect = document.getElementById('id_adresse_livraison');
        const adresseFacturationSelect = document.getElementById('id_adresse_facturation');
        const messageIdentique = document.getElementById('msgIdentique');
        const hiddenInput = document.getElementById('adresse_identique');
        
        // Fonction pour vérifier si les adresses sont identiques
        function checkIfAddressesAreIdentical() {
            const livraisonValue = adresseLivraisonSelect.value;
            const facturationValue = adresseFacturationSelect.value;
            
            if (livraisonValue === facturationValue) {
                // Les adresses sont identiques
                messageIdentique.classList.remove('hidden');
                hiddenInput.value = 'adresse_identique';
            } else {
                // Les adresses sont différentes
                messageIdentique.classList.add('hidden');
                hiddenInput.value = '';
            }
        }
        
        // Vérifier au chargement de la page
        checkIfAddressesAreIdentical();
        
        // Ajouter des écouteurs d'événements pour les changements de sélection
        adresseLivraisonSelect.addEventListener('change', checkIfAddressesAreIdentical);
        adresseFacturationSelect.addEventListener('change', checkIfAddressesAreIdentical);
    });
</script>
{% endblock %}
